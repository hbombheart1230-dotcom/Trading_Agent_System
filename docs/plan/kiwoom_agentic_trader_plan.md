# Kiwoom Agentic Trader 구현 플랜 (LangGraph + JSONL 카탈로그)

## 목표와 원칙
- 목적: **국내주식 자동매매 에이전트** (전략가 → 스캐너 → 모니터링 → 청산 → 피드백 루프)
- 원칙
  - `app.py`는 클래스 호출만
  - 오케스트레이션은 LangGraph
  - API 메타데이터는 JSONL 기반
  - Top-K 게이트로 API 폭발 방지
  - 모든 판단/호출/요약은 이벤트 로그로 기록

---

## 역할 정의
### 전략가
- 키움 데이터 + 뉴스 + 해외지수 맥락 사용
- 후보 3~5종목 선정

### 스캐너
- 전략가 후보를 깊게 검증
- 최종 1종목 선정

### 모니터
- 실시간 추적 및 청산

---

## 데이터 소스
- 뉴스: 네이버 증권
- 국내 지수/업종: 키움 API
- 해외 지수: 외부(전략가 맥락)

---

## 핵심 메커니즘
### Top-K 게이트
- 중분류 + tags → Top-K API 후보

### Spec 기반 실행
- api_id → endpoint/스키마

### 이벤트 로그
- events.jsonl 기록

---

## 타임라인
- M0: 리소스 정리 (완료)
- M1: 로그 뼈대
- M2: API 카탈로그(Top-K)
- M3: 전략가 MVP
- M4: 스캐너 MVP
- M5: 모니터링
- M6: 주문 게이트

---

## LangGraph 구성
- ensure_token
- strategist_plan
- candidate_topk
- fetch_data
- strategist_pick
- scanner_deepen
- monitor_loop

---

## 체크리스트(진행 중 확인용)
- [ ] 이벤트 로그가 노드마다 남는가?
- [ ] 전략가에게 던지는 후보 API는 항상 10~15개 이하인가?
- [ ] API 응답을 그대로 state에 넣지 않고 요약만 넣는가?
- [ ] 후보 선정 근거가 로그로 재현 가능한가?
- [ ] 주문/청산은 정책 게이트를 거치는가?

---

## 테스트 전략 및 마일스톤별 검증 기준
> 각 마일스톤은 **체크리스트 = 직접 실행 테스트 기준**으로 검증한다.

### 공통 테스트 원칙
- AI 판단의 정답을 테스트하지 않는다
- **형태/제약/흐름**만 테스트
  - 개수 제약
  - 호출 횟수
  - 상태 전이
  - 로그 생성 여부
- 외부 API 호출은 mock 우선

---

### M1. 로그 뼈대
**체크리스트**
- [ ] 노드 실행 시 events.jsonl에 기록
- [ ] run_id 기준으로 사이클 묶임

**테스트**
- tests/test_logger.py
- 더미 노드 실행 → 로그 생성 assert

---

### M2. API 카탈로그 (Top-K)
**체크리스트**
- [ ] K개 이하 반환
- [ ] tags 변경 시 결과 변화

**테스트**
- tests/test_api_catalog.py
- jsonl 고정 입력 assert

---

### M3. 전략가 MVP
**체크리스트**
- [ ] 중분류/tags 선택
- [ ] API 호출 2~4개
- [ ] 후보 3~5 생성

**테스트**
- executor mock
- 후보 개수 assert

---

### M4. 스캐너 MVP
**체크리스트**
- [ ] 후보 3~5만 사용
- [ ] 최종 1개
- [ ] 추가 루프 1회 이내

**테스트**
- 분봉/호가 mock
- 최종 선택 assert

---

### M5. 모니터링
**체크리스트**
- [ ] 상태 업데이트
- [ ] 트리거 이벤트

**테스트**
- 가격/시간 시뮬레이션

---

### M6. 주문 게이트
**체크리스트**
- [ ] 정책 통과 주문만 실행
- [ ] 차단 로그 기록

**테스트**
- 주문 파라미터 변형 테스트

#26/2/9
- M1: ensure_token 노드에 EventLogger start/end 로그 추가
- libs/api_catalog.py 추가/구현 (M2-1)
- tests/test_api_catalog.py 추가/구현 (M2-1)
